---
title: "Analysis"
author: "Nicholas Ray"
date: "12/13/2022"
output: pdf_document
---
<!-- Loading relevant libraries. -->
```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(here);library(readxl);library(plm);library(sandwich);library(gridExtra);
library(stargazer);library(tidyverse)
```

<!-- Loading relevant data. -->
```{r data, message=FALSE, warning=FALSE, include=FALSE}
unzip(here("Data","Loans","aiddataChina", "AidDatasGlobalChineseDevelopmentFinanceDataset_v2.0.zip"))
china<-read_excel(here("Code", "AidDatasGlobalChineseDevelopmentFinanceDataset_v2.0.xlsx"), sheet = 5)
unzip(here("Data","Debt","API_GC.DOD.TOTL.GD.ZS_DS2_en_csv_v2_4750057.zip"))
debt<-read_csv(here("Code","API_GC.DOD.TOTL.GD.ZS_DS2_en_csv_v2_4750057.csv"),skip=4)
unzip(here("Data","Loans","API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.zip"))
wb<-read_csv(here("Code","API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.csv"),skip=4)
polity<-read_excel(here("Data", "PoliticalFreedom", "p5v2018.xls"))
unzip(here("Data", "GDP", "UNdata_Export_20221013_234232609.zip"))
gdp<-read.csv(here("Code", "UNdata_Export_20221013_234232609.csv"))
dfp<-read_excel(here("Data", "DPFdevpolicyactiondatabase.xlsx"), sheet = 3)
```

<!-- Cleaning data. -->
```{r cleaning, message=FALSE, warning=FALSE, include=FALSE}
african_countries<-c("Algeria","Angola","Benin","Botswana","Burkina Faso",
                     "Burundi","Cabo Verde","Cameroon",
                     "Central African Republic","Chad","Comoros",
                     "Cote d'Ivoire","Democratic Republic of the Congo",
                     "Djibouti","Egypt","Equatorial Guinea","Eritrea",
                     "Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea",
                     "Guinea-Bissau","Kenya","Lesotho","Liberia","Libya",
                     "Madagascar","Malawi","Mali","Mauritania","Mauritius",
                     "Morocco","Mozambique","Namibia","Niger","Nigeria",
                     "Republic of the Congo","Rwanda","Sao Tome and Principe",
                     "Senegal","Seychelles","Sierra Leone","Somalia",
                     "South Africa","South Sudan","Sudan","Tanzania","Togo",
                     "Tunisia","Uganda","Zambia","Zimbabwe")
dfp["Country"][dfp["Country"] == "Congo"] <- "Republic of the Congo"
dfp["Country"][dfp["Country"] == "Congo, Democratic Republic of"] <- "Democratic Republic of the Congo"
dfp["Country"][dfp["Country"] == "Côte d'ivoire"] <- "Cote d'Ivoire"
dfp["Country"][dfp["Country"] == "Egypt, Arab Republic of"] <- "Egypt"
dfp["Country"][dfp["Country"] == "Gambia, The"] <- "Gambia"
dfp["Country"][dfp["Country"] == "The Gambia"] <- "Gambia"
dfp["Country"][dfp["Country"] == "Sierar Leone"] <- "Sierra Leone"
dfp<-subset(dfp,`Country` %in% african_countries)
dfp<-dfp %>%
  rename(country=Country,year=FY,project=`Project ID`) %>%
  mutate(conditions=1) %>%
  group_by(country,year,project) %>%
  summarise(conditions=sum(conditions)) %>%
  group_by(country,year) %>%
  summarise(avg_conditions=mean(conditions)) #avg cond per country per year
china["Recipient"][china["Recipient"] == "Congo"] <- "Republic of the Congo"
china<- subset(china, Recipient %in% african_countries)
china<-china %>%
  rename(country=`Recipient`,year=`Commitment Year`) %>% #chose commitment year as year, maybe controversial
  filter(`Flow Type`=="Loan") %>%
  group_by(country,year) %>%
  summarise(cloan=sum(`Amount (Nominal)`)) #constant usd 2017
china2<-china %>% 
  group_by(country) %>% 
  mutate(beginning = 2000) %>%
  select(-cloan, -year) %>% 
  distinct() %>%
  expand(year = beginning:2017, beginning) %>%
  select(-beginning)
china<- china2 %>%
  left_join(china, by = c("country", "year"))
wb<-wb %>%
  pivot_longer("1960":"2021", names_to = "year", values_to = "wbloan") %>%
  rename(country=`Country Name`) %>%
  select(-`...67`,-`Indicator Code`,-`Indicator Name`,-`Country Code`) %>%
  filter(year > "1999" & year < "2018") %>%
  transform(year=as.numeric(year))
wb["country"][wb["country"] == "Congo, Rep."] <- "Republic of the Congo"
wb["country"][wb["country"] == "Congo, Dem. Rep."] <- "Democratic Republic of the Congo"
wb["country"][wb["country"] == "Egypt, Arab Rep."] <- "Egypt"
wb["country"][wb["country"] == "Gambia, The"] <- "Gambia"
wb<-subset(wb, country %in% african_countries)
polity["country"][polity["country"] == "Cape Verde"] <- "Cabo Verde"
polity["country"][polity["country"] == "Congo-Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Kinshasa"] <- "Democratic Republic of the Congo"
polity["country"][polity["country"] == "Cote D'Ivoire"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Ivory Coast"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Swaziland"] <- "Eswatini"
polity<-subset(polity, `country` %in% african_countries)
polity<-polity %>%
  filter(`year` > "1999" & `year` < "2018") %>%
  select(`country`,`year`,`polity2`) %>%
  rename(polity=`polity2`) 
gdp["Country.or.Area"][gdp["Country.or.Area"] == "CÃ´te d'Ivoire"] <- "Cote d'Ivoire"
gdp["Country.or.Area"][gdp["Country.or.Area"] == "Congo"] <- "Republic of the Congo"
gdp["Country.or.Area"][gdp["Country.or.Area"] == " Former Sudan"]<- "South Sudan"
gdp<-subset(gdp, `Country.or.Area` %in% african_countries)
gdp<-gdp %>%
  filter(`Year` > "1999" & `Year` < "2018") %>%
  select(`Country.or.Area`,`Year`,`Value`) %>%
  rename(country=`Country.or.Area`,year=Year,gdp=Value)
data<-full_join(wb, polity, by = c("country","year")) %>%
  full_join(., gdp, by = c("country","year")) %>%
  full_join(., china, by = c("country","year"))
data["cloan"][is.na(data["cloan"])] <- 0 #reasonable assumption?
data["wbloan"][is.na(data["wbloan"])] <- 0
deflator<-read.csv(here("Data","GDP","USAGDPDEFAISMEI.csv"))
#gdp deflator found here https://fred.stlouisfed.org/series/usagdpdefaismei
deflator<- rename(deflator,value=USAGDPDEFAISMEI)
deflator<- subset(deflator,value < 103 & value > 73) %>%
  select(value)
deflator<- as.matrix(deflator)
deflator<- deflator * 0.01
deflator<- rep(deflator,times=54) #54 countries
deflator<- as.matrix(deflator)
deflator<-1/deflator
data$cloan<-diag(data$cloan) %*% deflator
data$wbloan<-diag(data$wbloan) %*% deflator
data<-data %>%
  mutate(log_cloan=log(cloan),log_wbloan=log(wbloan),
         log_gdp=log(gdp))
data["log_cloan"][data["log_cloan"] == -Inf] <- 0
data["log_wbloan"][data["log_wbloan"] == -Inf] <- 0
data<-mutate(data,mixing=(log_wbloan-log_cloan))
```
```{r figures, include=FALSE,warning=FALSE,message=FALSE}
library(panelr)
data_p<-panel_data(data,id=country,wave=year)
data_p1<-subset(data_p,`country` %in% c("Algeria","Angola","Benin","Botswana",
                                        "Burundi","Burkina Faso","Cabo Verde",
                                        "Cameroon","Central African Republic",
                                        "Chad","Comoros","Cote d'Ivoire",
                                        "Democratic Republic of the Congo",
                                        "Djibouti","Egypt","Equatorial Guinea",
                                        "Eritrea","Eswatini","Ethiopia","Gabon",
                                        "Gambia","Ghana","Guinea","Guinea-Bissau",
                                        "Kenya","Lesotho"))
plot1<-data_p1 %>% #using 1700 width, 1200 height for export
  line_plot(mixing, 
            overlay = FALSE,
            add.mean = TRUE)
data_p2<-subset(data_p,`country` %in% c("Liberia","Libya",
                                        "Madagascar","Malawi","Mali","Mauritania",
                                        "Somalia","Mauritius","Morocco",
                                        "Mozambique","Namibia","Niger","Nigeria",
                                        "Republic of the Congo","Rwanda","Senegal",
                                        "Sierra Leone","South Africa","Togo",
                                        "Tunisia","Uganda","Seychelles",
                                        "South Sudan","Sudan","Sao Tome and Principe",
                                        "Tanzania","Zambia","Zimbabwe"))
plot2<-data_p2 %>%
  line_plot(mixing, 
            overlay = FALSE,
            add.mean = TRUE)
```