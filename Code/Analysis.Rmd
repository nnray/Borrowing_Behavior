---
title: "Analysis"
author: "Nicholas Ray"
date: "12/13/2022"
output: html_document
---
<!-- Loading relevant libraries. -->
```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(here);library(plm);library(sandwich);library(gridExtra);library(readxl);
library(sf);library(sfExtras);library(tmap);library(tmaptools);library(panelr);
library(stargazer);library(readstata13);library(spdep);library(lmtest);
library(spatialreg);library(splm);library(tidyverse)
```

<!-- Loading relevant data. -->
```{r data, message=FALSE, warning=FALSE, include=FALSE}
#loans
china<-read_excel(
  unzip(here("data","loans",
             "AidDatasGlobalChineseDevelopmentFinanceDataset_v2.0.zip")),
        sheet=5
  )
wb<-read_csv(
  unzip(here("data","loans","API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.zip"),
        "API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.csv"),
  skip=4
  )
dfp<-read_excel(
  here("data","loans","DPFdevpolicyactiondatabase.xlsx"),
  sheet=3
  )
#gdp
gdp<-read.csv(
  unzip(here("data","gdp","UNdata_Export_20221013_234232609.zip"),
        "UNdata_Export_20221013_234232609.csv"),
  )
deflator<-read.csv( #found at https://fred.stlouisfed.org/series/usagdpdefaismei
  here("data","gdp","USAGDPDEFAISMEI.csv")
  )
#politics
polity<-read_excel(
  here("data","politics","p5v2018.xls")
  )
voting<-read.dta13(
  here("data","politics","Apples_and_Dragonfruits_Replication_Data",
       "dragon_fruits.dta")
  )
#conflict
ucdp<-read_xlsx(
  unzip(here("data","conflict","ucdp-prio-acd-221-xlsx.zip"))
  )
#climate
emissions<-read.csv(
  unzip(here("data","climate",
             "P_Data_Extract_From_World_Development_Indicators.zip"),
        "f9f2f018-84e3-4634-9d43-156d9e836b14_Data.csv")
  )
#shapefiles
africa<-{
  unzip(here("data","shapefiles","afr_g2014_2013_0.zip"))
  st_read(here("code","afr_g2014_2013_0.shp"))
}
```

<!-- Cleaning data. -->
```{r cleaning, message=FALSE, warning=FALSE, include=FALSE}
figure2.2<-china #stashing uncleaned data for figure making, will be overwritten by figure code
figure2.3<-wb
#for some reason I find country codes unreliable, so here I am declaring the
#names of all African countries to use in future subsetting
african_countries<-c("Algeria","Angola","Benin","Botswana","Burkina Faso",
                     "Burundi","Cabo Verde","Cameroon",
                     "Central African Republic","Chad","Comoros",
                     "Cote d'Ivoire","Democratic Republic of the Congo",
                     "Djibouti","Egypt","Equatorial Guinea","Eritrea",
                     "Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea",
                     "Guinea-Bissau","Kenya","Lesotho","Liberia","Libya",
                     "Madagascar","Malawi","Mali","Mauritania","Mauritius",
                     "Morocco","Mozambique","Namibia","Niger","Nigeria",
                     "Republic of the Congo","Rwanda","Sao Tome and Principe",
                     "Senegal","Seychelles","Sierra Leone","Somalia",
                     "South Africa","South Sudan","Sudan","Tanzania","Togo",
                     "Tunisia","Uganda","Zambia","Zimbabwe")
################################################################################
#cleaning the UNGA voting data from Dreher et al. replication data
voting["recipient_condensed"][voting["recipient_condensed"] == "Congo, Rep."] <- "Republic of the Congo"
voting["recipient_condensed"][voting["recipient_condensed"] == "Congo, Dem. Rep."] <- "Democratic Republic of the Congo"
voting["recipient_condensed"][voting["recipient_condensed"] == "Central African Rep."] <- "Central African Republic"
voting["recipient_condensed"][voting["recipient_condensed"] == "Cote D'Ivoire"] <- "Cote d'Ivoire"
voting["recipient_condensed"][voting["recipient_condensed"] == "Cape Verde"] <- "Cabo Verde"
voting["recipient_condensed"][voting["recipient_iso3"] == "SWZ"] <- "Eswatani"
voting["recipient_condensed"][voting["recipient_iso3"] == "GMB"] <- "Gambia"
voting["recipient_condensed"][voting["recipient_iso3"] == "BFA"] <- "Burkina Faso"
voting["recipient_condensed"][voting["recipient_iso3"] == "STP"] <- "Sao Tome and Principe"
voting<-voting %>%
  rename(country=recipient_condensed,year=time,lag_cvote=LINLINECHN,lag_usvote=LINLINEUSA) %>%
  select(country,year,lag_cvote,lag_usvote) %>%
  filter(year > "2003" & year < "2018") %>%
  subset(country %in% african_countries)
################################################################################
#cleaning the data on WB loan conditionality
dfp["Country"][dfp["Country"] == "Congo"] <- "Republic of the Congo"
dfp["Country"][dfp["Country"] == "Congo, Democratic Republic of"] <- "Democratic Republic of the Congo"
dfp["Country"][dfp["Country"] == "Côte d'ivoire"] <- "Cote d'Ivoire"
dfp["Country"][dfp["Country"] == "Egypt, Arab Republic of"] <- "Egypt"
dfp["Country"][dfp["Country"] == "Gambia, The"] <- "Gambia"
dfp["Country"][dfp["Country"] == "The Gambia"] <- "Gambia"
dfp["Country"][dfp["Country"] == "Sierar Leone"] <- "Sierra Leone"
dfp<-dfp %>%
  rename(country=Country,year=FY,project=`Project ID`) %>%
  subset(country %in% african_countries) %>%
  filter(year > "2003" & year < "2018") %>%
  mutate(conditions=1) %>%
  group_by(country,year,project) %>%
  summarise(conditions=sum(conditions)) %>%
  group_by(country,year) %>%
  summarise(conditions=mean(conditions)) #`conditions` is now the average number
#of conditions per project in a given country year
################################################################################
#cleaning the data on Chinese loans
china["Recipient"][china["Recipient"] == "Congo"] <- "Republic of the Congo"
china<-china %>%
  rename(country=`Recipient`,year=`Commitment Year`) %>% #chose commitment year as `year`, maybe controversial
  subset(country %in% african_countries) %>%
  filter(`Flow Type`=="Loan",year > "2003" & year < "2018") %>%
  group_by(country,year) %>%
  summarise(cloan=sum(`Amount (Nominal)`))#constant usd 2017
################################################################################
#cleaning the data on WB loans
wb["Country Name"][wb["Country Name"] == "Congo, Rep."] <- "Republic of the Congo"
wb["Country Name"][wb["Country Name"] == "Congo, Dem. Rep."] <- "Democratic Republic of the Congo"
wb["Country Name"][wb["Country Name"] == "Egypt, Arab Rep."] <- "Egypt"
wb["Country Name"][wb["Country Name"] == "Gambia, The"] <- "Gambia"
wb<-wb %>%
  pivot_longer("1960":"2021", names_to = "year", values_to = "wbloan") %>%
  rename(country=`Country Name`) %>%
  subset(country %in% african_countries) %>%
  select(-`...67`,-`Indicator Code`,-`Indicator Name`,-`Country Code`) %>%
  filter(year > "2003" & year < "2018") %>%
  transform(year=as.numeric(year))
################################################################################
#cleaning the data on Polity scores
polity["country"][polity["country"] == "Cape Verde"] <- "Cabo Verde"
polity["country"][polity["country"] == "Congo-Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Kinshasa"] <- "Democratic Republic of the Congo"
polity["country"][polity["country"] == "Cote D'Ivoire"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Ivory Coast"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Swaziland"] <- "Eswatini"
polity<-polity %>%
  subset(country %in% african_countries) %>%
  filter(`year` > "2003" & `year` < "2018") %>%
  select(`country`,`year`,`polity2`) %>%
  rename(polity=`polity2`)
################################################################################
#cleaning the data on GDP per capita
gdp["Country.or.Area"][gdp["Country.or.Area"] == "CÃ´te d'Ivoire"] <- "Cote d'Ivoire"
gdp["Country.or.Area"][gdp["Country.or.Area"] == "Congo"] <- "Republic of the Congo"
gdp["Country.or.Area"][gdp["Country.or.Area"] == " Former Sudan"]<- "South Sudan"
gdp<-gdp %>%
  filter(`Year` > "2003" & `Year` < "2018") %>%
  select(`Country.or.Area`,`Year`,`Value`) %>%
  subset(`Country.or.Area` %in% african_countries) %>%
  rename(country=`Country.or.Area`,year=Year,gdp=Value)
################################################################################
#cleaning conflict data
ucdp<-ucdp%>%
  mutate(country=strsplit(as.character(location), ", ")) %>%
  unnest(country) %>%
  mutate(conflict=1) %>%
  group_by(country,year) %>%
  summarise(country, year, conflicts=sum(conflict)) %>%
  distinct() %>%
  filter(year > "2003" & year < "2018") %>%
  subset(country %in% african_countries)
################################################################################
#cleaning WB sustainable goal of reduced emissions
emissions<-emissions %>%
  pivot_longer("X1997..YR1997.":"X2021..YR2021.",names_to = "year",
               values_to = "emissions") %>%
  rename(country=Country.Name) %>%
  select(country,year,emissions)
emissions$emissions<-as.numeric(emissions$emissions)
emissions$year<-str_remove(emissions$year,"\\..*")
emissions$year<-as.numeric(str_remove(emissions$year,"X"))
emissions<-emissions %>%
  filter("2003"<year & year<"2018") %>%
  subset(country %in% african_countries)
################################################################################
#cleaning shapefile for later use
africa["ADM0_NAME"][[1]][africa["ADM0_NAME"][[1]]=="United Republic of Tanzania"]<-"Tanzania"
africa["ADM0_NAME"][[1]][africa["ADM0_NAME"][[1]]=="Congo"]<-"Republic of the Congo"
africa["ADM0_NAME"][[1]][africa["ADM0_NAME"][[1]]=="Côte d'Ivoire"]<-"Cote d'Ivoire"
africa["ADM0_NAME"][[1]][africa["ADM0_NAME"][[1]]=="Swaziland"]<-"Eswatini"
africa["ADM0_NAME"][[1]][africa["ADM0_NAME"][[1]]=="Cape Verde"]<-"Cabo Verde"
africa<-africa %>%
  rename(country=`ADM0_NAME`)%>%
  subset(country %in% african_countries)
################################################################################
#creating dataset
data<-full_join(ucdp, polity, by = c("country","year")) %>%
  full_join(., emissions, by = c("country","year")) %>%
  full_join(., dfp, by = c("country","year")) %>%
  full_join(., china, by = c("country","year")) %>%
  full_join(., wb, by = c("country","year")) %>%
  full_join(., gdp, by = c("country","year")) %>%
  full_join(., voting, by = c("country","year"))
#dealing with some of the missingness
data["cloan"][is.na(data["cloan"])] <- 0 #assuming didn't receive loans if NA
data["wbloan"][is.na(data["wbloan"])] <- 0 #assuming didn't receive loans if NA
data["conflicts"][is.na(data["conflicts"])] <- 0 #assuming no conflict if NA
#impute missingness for `conditions` (using average of yearly averages across all countries)
#data["conditions"][is.na(data["conditions"])] <-{
#  data %>%
#    select(year,conditions) %>%
#    drop_na() %>%
#    group_by(year) %>%
#    summarise(conditions=mean(conditions)) %>%
#    ungroup() %>%
#    summarise(conditions=mean(conditions)) %>%
#    as.integer()
#}
################################################################################
#rebasing loan data to real 2015 US $
deflator<- deflator %>%
  rename(value=USAGDPDEFAISMEI) %>%
  subset(value < 103 & value > 80) %>%
  select(value) %>%
  as.matrix() %>%
  rep(times=54) %>%
  as.matrix()
deflator<-1/(deflator * 0.01)
data$cloan<-diag(data$cloan) %*% deflator
data$wbloan<-diag(data$wbloan) %*% deflator
################################################################################
#after rebasing, some data manipulation:
##logging financial data for easier comparison
data<-data %>%
  mutate(log_cloan=log(cloan),log_wbloan=log(wbloan),
         log_gdp=log(gdp))
data["log_cloan"][data["log_cloan"] == -Inf] <- 0
data["log_wbloan"][data["log_wbloan"] == -Inf] <- 0
##creating DV for first model
data<-data %>%
  group_by(country,year) %>%
  mutate(total=log_cloan+log_wbloan)
################################################################################
#creating temporal/spatial lags
##temporal lags
data<-data %>% 
  ungroup() %>%
  mutate(lag_total=dplyr::lag(total),lag_conflicts=dplyr::lag(conflicts),
         lag_emissions=dplyr::lag(emissions),lag_log_cloan=dplyr::lag(log_cloan))
##w matrix for spatial lags later (under "analysis")
w<-merge(africa,data,by=c("country")) %>%
  st_queen() %>%
  st_as_nb() %>%
  write.nb.gal(.,here(file = "w"))
w2<-read.gal(here("w"))
```

<!-- Making figures. -->
```{r figures, include=FALSE,warning=FALSE,message=FALSE}
#figure 1
figure1.1<-panel_data(data,id=country,wave=year) %>% #to use with line_plot()
  subset(country %in% c("Algeria","Angola","Benin","Botswana","Burundi",
                        "Burkina Faso","Cabo Verde","Cameroon",
                        "Central African Republic","Chad","Comoros",
                        "Cote d'Ivoire","Democratic Republic of the Congo",
                        "Djibouti","Egypt","Equatorial Guinea","Eritrea",
                        "Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea",
                        "Guinea-Bissau","Kenya","Lesotho")) %>%
  line_plot(log_wbloan,overlay = FALSE) +
  geom_line(mapping=aes(y=log_cloan))
figure1.2<-panel_data(data,id=country,wave=year) %>% #to use with line_plot()
  subset(country %in% c("Liberia","Libya","Madagascar","Malawi","Mali",
                        "Mauritania","Somalia","Mauritius","Morocco",
                        "Mozambique","Namibia","Niger","Nigeria",
                        "Republic of the Congo","Rwanda","Senegal",
                        "Sierra Leone","South Africa","Togo","Tunisia","Uganda",
                        "Seychelles","South Sudan","Sudan",
                        "Sao Tome and Principe","Tanzania","Zambia","Zimbabwe")) %>%
  line_plot(log_wbloan,overlay = FALSE) +
  geom_line(mapping=aes(y=log_cloan))
#type "figure1._" in console, use 1700 width and 1200 height for export
################################################################################
#figure 2
figure2.1<-data %>%
  select(year,conditions) %>%
  drop_na() %>% #na's from UNGA voting data distorts graph if this is done too early
  group_by(year) %>%
  summarise(conditions=sum(conditions)) %>% #sum of every country's avg conditions per project in a given year
  select(-year) %>%
  ts(.,start = 2004,end = 2017)
figure2.2<-figure2.2 %>% #using full sample of Chinese data (2000-2017), nominal dollars
  rename(country=`Recipient`,year=`Commitment Year`) %>% #chose commitment year as `year`, maybe controversial
  subset(country %in% african_countries) %>%
  filter(`Flow Type`=="Loan") %>%
  select(year,`Amount (Constant USD2017)`) %>%
  drop_na() %>%
  group_by(year) %>%
  summarise(cloan=sum(`Amount (Constant USD2017)`)) %>% #constant USD 2015 in cleaned dataset above
  select(-year) %>%
  ts(.,start = 2000,end = 2017)
figure2.3<-figure2.3 %>%
  pivot_longer("1960":"2021", names_to = "year", values_to = "wbloan") %>%
  rename(country=`Country Name`) %>%
  subset(country %in% african_countries) %>%
  select(year,wbloan) %>%
  filter(year > "1999" & year < "2018") %>%
  drop_na() %>%
  transform(year=as.numeric(year)) %>%
  group_by(year) %>%
  summarise(wbloan=sum(wbloan)) %>%
  select(-year) %>%
  ts(.,start = 2000,end = 2017)
#type "plot.ts(figure2._,ylim=c(0,8e+10))" in console, use width 550 and height 500 for export
```

<!-- Conducting diagnostics. -->
```{r diagnostics}
################################################################################
#panel unit root testing
##conflict
purtest(
  object={
    data %>%
      select(country,year,conflicts) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(conflicts) #stationary
  },
  test = "invnormal"
)
##polity
purtest(
  object={
    data %>%
      select(country,year,polity) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(polity) #stationary
  },
  test = "invnormal"
)
##emissions
purtest(
  object={
    data %>%
      select(country,year,emissions) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(emissions) #stationary
  },
  test = "invnormal"
)
##conditions
purtest(
  object={
    data %>%
      select(country,year,conditions) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(conditions) #trendstationary
  },
  exo = "trend", 
  test = "invnormal"
)
##lag_cvote
purtest(
  object={
    data %>%
      select(country,year,lag_cvote) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(lag_cvote) #trendstationary
  },
  exo = "trend",
  test = "invnormal"
)
##lag_usvote
purtest(
  object={
    data %>%
      select(country,year,lag_usvote) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(lag_usvote) #trendstationary
  },
  exo = "trend",
  test = "invnormal"
)
##log_cloan
purtest(
  object={
    data %>%
      select(country,year,log_cloan) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(log_cloan) #stationary
  },
  test = "invnormal"
)
##log_wbloan
purtest(
  object={
    data %>%
      select(country,year,log_wbloan) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(log_wbloan) #trendstationary
  },
  exo = "trend",
  test = "invnormal"
)
##log_gdp
purtest(
  object={
    data %>%
      select(country,year,log_gdp) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(log_gdp) #trendstationary
  },
  exo = "trend",
  test = "invnormal"
)
##total
purtest(
  object={
    data %>%
      select(country,year,total) %>%
      drop_na() %>%
      pdata.frame(index = c("country","year")) %>%
      select(total) #trendstationary
  },
  exo = "trend",
  test = "invnormal"
)
#conclusion: all variables at least panel trendstationary, so include period effects for detrending
################################################################################
#temporal/spatial dependence diagnostics
##fitting theoretical model (with theoretically motivated temporal/spatial lags) plus period effects from panel unit root test conclusion and checking for heteroskedasticity, serial correlation, unit effects, and unmodeled spatial dependence in residuals
###model 1
model1<-plm(total~lag_total+conditions+lag_cvote+log_gdp+polity,
               data,effect="time",model="pooling",index=c("country","year"))
bptest(model1) #heteroskedasticity
pbgtest(model1) #no serial correlation
plmtest(model1, effect = "individual", type = c("bp")) #pooling ok
w<-nb2listw(w$neighbours,style="W")
moran.test(summary(model1)$residuals,w)
plm:::summary.plm(model1, #using country clustered se
                  vcov=vcovHC(model1,method=c("white1"),type=c("HC1"),cluster=c("group"))) 
###model 2
library(devtools); devtools::install_github("judechays/STADL", dependencies = TRUE)
library(tscsdep)
model2<-lagsarlm(conflicts~lag_conflicts+conditions+log_gdp+polity+as.factor(year),
                 data=data,w,Durbin=~conflicts+log_gdp+polity)
bptest(model2) #
pbgtest(model2) #
plmtest(model2, effect = "individual", type = c("bp")) #
moran.test(summary(model2)$residuals,w)
###model 3
model3<-lagsarlm(emissions~lag_emissions+log_cloan+lag_log_cloan+log_gdp+as.factor(year),
                 data=data,w,Durbin=~emissions+log_gdp)
bptest(model3) #
pbgtest(model3) #
plmtest(model3, effect = "individual", type = c("bp")) #
moran.test(summary(model3)$residuals,w)
################################################################################
#missing data? slide 38, Amelia lab
```


Model 1:
Theoretical spatial/temporal dependence (temporal LDV)
Fixed effects (no FE)
Heteroskedasticity (country clustered)
Serial Correlation (none)
*Spatial dependence in residuals (?)

Model 2:
Theoretical spatial/temporal dependence (temporal LDV, possibly spatial LDV, possibly spatial X (gdp, polity))
*Fixed effects
*Heteroskedasticity
*Serial Correlation
*Spatial dependence in residuals

Model 3:
Theoretical spatial/temporal dependence (temporal LDV; possibly spatial LDV; possibly spatial X (gdp); possible temporal X (cloan)) but not spatial X, cuz one country taking Chinese money shouldn't affect the conditions and effectiveness of WB in other countries
*Fixed effects
*Heteroskedasticity
*Serial Correlation
*Spatial dependence in residuals
<!-- Building and analyzing empirical models. -->
```{r analysis}
#final models
```

<!-- Making tables of results. -->
```{r tables}
#stargazer
```