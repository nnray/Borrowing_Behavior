---
title: "Analysis"
author: "Nicholas Ray"
date: "12/13/2022"
output: html_document
---
<!-- Loading relevant libraries. -->
```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(here);library(plm);library(sandwich);library(gridExtra);library(readxl);
library(panelr);library(stargazer);library(readstata13);library(tidyverse)
```

<!-- Loading relevant data. -->
```{r data, message=FALSE, warning=FALSE, include=FALSE}
#loans
china<-read_excel(
  unzip(here("data","loans",
             "AidDatasGlobalChineseDevelopmentFinanceDataset_v2.0.zip")),
        sheet=5
  )
wb<-read_csv(
  unzip(here("data","loans","API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.zip"),
        "API_DT.DOD.MWBG.CD_DS2_en_csv_v2_4523873.csv"),
  skip=4
  )
dfp<-read_excel(
  here("data","loans","DPFdevpolicyactiondatabase.xlsx"),
  sheet=3
  )
#gdp
gdp<-read.csv(
  unzip(here("data","gdp","UNdata_Export_20221013_234232609.zip"),
        "UNdata_Export_20221013_234232609.csv"),
  )
deflator<-read.csv( #found at https://fred.stlouisfed.org/series/usagdpdefaismei
  here("data","gdp","USAGDPDEFAISMEI.csv")
  )
#politics
polity<-read_excel(
  here("data","politics","p5v2018.xls")
  )
voting<-read.dta13(
  here("data","politics","Apples_and_Dragonfruits_Replication_Data","dragon_fruits.dta"),
)
#conflict
ucdp<-read_xlsx(
  unzip(here("data","conflict","ucdp-prio-acd-221-xlsx.zip"))
  )
#climate
emissions<-read.csv(
  unzip(here("data","climate",
             "P_Data_Extract_From_World_Development_Indicators.zip"),
        "f9f2f018-84e3-4634-9d43-156d9e836b14_Data.csv")
)
```

<!-- Cleaning data. -->
```{r cleaning, message=FALSE, warning=FALSE, include=FALSE}
#for some reason I find country codes unreliable, so here I am declaring the
#names of all African countries to use in future subsetting
african_countries<-c("Algeria","Angola","Benin","Botswana","Burkina Faso",
                     "Burundi","Cabo Verde","Cameroon",
                     "Central African Republic","Chad","Comoros",
                     "Cote d'Ivoire","Democratic Republic of the Congo",
                     "Djibouti","Egypt","Equatorial Guinea","Eritrea",
                     "Eswatini","Ethiopia","Gabon","Gambia","Ghana","Guinea",
                     "Guinea-Bissau","Kenya","Lesotho","Liberia","Libya",
                     "Madagascar","Malawi","Mali","Mauritania","Mauritius",
                     "Morocco","Mozambique","Namibia","Niger","Nigeria",
                     "Republic of the Congo","Rwanda","Sao Tome and Principe",
                     "Senegal","Seychelles","Sierra Leone","Somalia",
                     "South Africa","South Sudan","Sudan","Tanzania","Togo",
                     "Tunisia","Uganda","Zambia","Zimbabwe")
################################################################################
#cleaning the UNGA voting data from Dreher et al. replication data
voting["recipient_condensed"][voting["recipient_condensed"] == "Congo, Rep."] <- "Republic of the Congo"
voting["recipient_condensed"][voting["recipient_condensed"] == "Congo, Dem. Rep."] <- "Democratic Republic of the Congo"
voting["recipient_condensed"][voting["recipient_condensed"] == "Central African Rep."] <- "Central African Republic"
voting["recipient_condensed"][voting["recipient_condensed"] == "Cote D'Ivoire"] <- "Cote d'Ivoire"
voting["recipient_condensed"][voting["recipient_condensed"] == "Cape Verde"] <- "Cabo Verde"
voting["recipient_condensed"][voting["recipient_iso3"] == "SWZ"] <- "Eswatani"
voting["recipient_condensed"][voting["recipient_iso3"] == "GMB"] <- "Gambia"
voting["recipient_condensed"][voting["recipient_iso3"] == "BFA"] <- "Burkina Faso"
voting["recipient_condensed"][voting["recipient_iso3"] == "STP"] <- "Sao Tome and Principe"
voting<-subset(voting,`recipient_condensed` %in% african_countries)
voting<-voting %>%
  rename(country=recipient_condensed,year=time,lag_cvote=LINLINECHN,lag_usvote=LINLINEUSA) %>%
  select(country,year,lag_cvote,lag_usvote) %>%
  filter(year > "1999" & year < "2018")
################################################################################
#cleaning the data on WB loan conditionality
dfp["Country"][dfp["Country"] == "Congo"] <- "Republic of the Congo"
dfp["Country"][dfp["Country"] == "Congo, Democratic Republic of"] <- "Democratic Republic of the Congo"
dfp["Country"][dfp["Country"] == "Côte d'ivoire"] <- "Cote d'Ivoire"
dfp["Country"][dfp["Country"] == "Egypt, Arab Republic of"] <- "Egypt"
dfp["Country"][dfp["Country"] == "Gambia, The"] <- "Gambia"
dfp["Country"][dfp["Country"] == "The Gambia"] <- "Gambia"
dfp["Country"][dfp["Country"] == "Sierar Leone"] <- "Sierra Leone"
dfp<-subset(dfp,`Country` %in% african_countries)
dfp<-dfp %>%
  rename(country=Country,year=FY,project=`Project ID`) %>%
  filter(year > "1999" & year < "2018") %>%
  mutate(conditions=1) %>%
  group_by(country,year,project) %>%
  summarise(conditions=sum(conditions)) %>%
  group_by(country,year) %>%
  summarise(conditions=mean(conditions)) #`conditions` is now the average number
#of conditions per project in a given country year
################################################################################
#cleaning the data on Chinese loans
china["Recipient"][china["Recipient"] == "Congo"] <- "Republic of the Congo"
china<- subset(china, Recipient %in% african_countries)
china<-china %>%
  rename(country=`Recipient`,year=`Commitment Year`) %>% #chose commitment year as `year`, maybe controversial
  filter(`Flow Type`=="Loan") %>%
  group_by(country,year) %>%
  summarise(cloan=sum(`Amount (Nominal)`)) #constant usd 2017
################################################################################
#cleaning the data on WB loans
wb<-wb %>%
  pivot_longer("1960":"2021", names_to = "year", values_to = "wbloan") %>%
  rename(country=`Country Name`) %>%
  select(-`...67`,-`Indicator Code`,-`Indicator Name`,-`Country Code`) %>%
  filter(year > "1999" & year < "2018") %>%
  transform(year=as.numeric(year))
wb["country"][wb["country"] == "Congo, Rep."] <- "Republic of the Congo"
wb["country"][wb["country"] == "Congo, Dem. Rep."] <- "Democratic Republic of the Congo"
wb["country"][wb["country"] == "Egypt, Arab Rep."] <- "Egypt"
wb["country"][wb["country"] == "Gambia, The"] <- "Gambia"
wb<-subset(wb, country %in% african_countries)
################################################################################
#cleaning the data on Polity scores
polity["country"][polity["country"] == "Cape Verde"] <- "Cabo Verde"
polity["country"][polity["country"] == "Congo-Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Brazzaville"] <- "Republic of the Congo"
polity["country"][polity["country"] == "Congo Kinshasa"] <- "Democratic Republic of the Congo"
polity["country"][polity["country"] == "Cote D'Ivoire"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Ivory Coast"] <- "Cote d'Ivoire"
polity["country"][polity["country"] == "Swaziland"] <- "Eswatini"
polity<-subset(polity, `country` %in% african_countries)
polity<-polity %>%
  filter(`year` > "1999" & `year` < "2018") %>%
  select(`country`,`year`,`polity2`) %>%
  rename(polity=`polity2`)
################################################################################
#cleaning the data on GDP per capita
gdp["Country.or.Area"][gdp["Country.or.Area"] == "CÃ´te d'Ivoire"] <- "Cote d'Ivoire"
gdp["Country.or.Area"][gdp["Country.or.Area"] == "Congo"] <- "Republic of the Congo"
gdp["Country.or.Area"][gdp["Country.or.Area"] == " Former Sudan"]<- "South Sudan"
gdp<-subset(gdp, `Country.or.Area` %in% african_countries)
gdp<-gdp %>%
  filter(`Year` > "1999" & `Year` < "2018") %>%
  select(`Country.or.Area`,`Year`,`Value`) %>%
  rename(country=`Country.or.Area`,year=Year,gdp=Value)
################################################################################
#cleaning conflict data
ucdp<-ucdp%>%
  mutate(country=strsplit(as.character(location), ", ")) %>%
  unnest(country) %>%
  mutate(conflict=1) %>%
  group_by(country,year) %>%
  summarise(country, year, conflicts=sum(conflict)) %>%
  distinct() %>%
  filter(year > "1999" & year < "2018")
ucdp<-subset(ucdp, `country` %in% african_countries)
################################################################################
#cleaning WB sustainable goal of reduced emissions
emissions<-emissions %>%
  pivot_longer("X1997..YR1997.":"X2021..YR2021.",names_to = "year",
               values_to = "emissions") %>%
  rename(country=Country.Name) %>%
  select(country,year,emissions)
emissions$emissions<-as.numeric(emissions$emissions)
emissions$year<-str_remove(emissions$year,"\\..*")
emissions$year<-as.numeric(str_remove(emissions$year,"X"))
emissions<-filter(emissions,"1999"<year & year<"2018")
emissions<-subset(emissions, country %in% african_countries)
################################################################################
#creating dataset
data<-full_join(ucdp, polity, by = c("country","year")) %>%
  full_join(., emissions, by = c("country","year")) %>%
  full_join(., dfp, by = c("country","year")) %>%
  full_join(., china, by = c("country","year")) %>%
  full_join(., wb, by = c("country","year")) %>%
  full_join(., gdp, by = c("country","year")) %>%
  full_join(., voting, by = c("country","year"))
#dealing with missingness
data["cloan"][is.na(data["cloan"])] <- 0 #assuming didn't receive loans if NA
data["wbloan"][is.na(data["wbloan"])] <- 0 #assuming didn't receive loans if NA
data["conflicts"][is.na(data["conflicts"])] <- 0 #assuming no conflict if NA
#impute missingness for `conditions` (using average of yearly averages across all countries)
conditions_missing<- data %>%
  drop_na() %>%
  group_by(year) %>%
  mutate(conditions_missing=mean(conditions)) %>%
  ungroup() %>%
  summarise(mean(conditions_missing))
data_imputed<-data
data_imputed["conditions"][is.na(data_imputed["conditions"])] <- conditions_missing[[1]]
################################################################################
#rebasing loan data to real 2015 US $
deflator<- rename(deflator,value=USAGDPDEFAISMEI)
deflator<- subset(deflator,value < 103 & value > 73) %>%
  select(value)
deflator<- as.matrix(deflator)
deflator<- deflator * 0.01
deflator<- rep(deflator,times=54) #54 countries
deflator<- as.matrix(deflator)
deflator<-1/deflator
data$cloan<-diag(data$cloan) %*% deflator
data$wbloan<-diag(data$wbloan) %*% deflator
################################################################################
#after rebasing, some data manipulation:
#logging financial data for easier comparison
data<-data %>%
  mutate(log_cloan=log(cloan),log_wbloan=log(wbloan),
         log_gdp=log(gdp))
data["log_cloan"][data["log_cloan"] == -Inf] <- 0
data["log_wbloan"][data["log_wbloan"] == -Inf] <- 0
#creating DV for first model
data<-data %>%
  group_by(country,year) %>%
  mutate(borrowing=log_cloan+log_wbloan)
```

<!-- Making figures. -->
```{r figures, include=FALSE,warning=FALSE,message=FALSE}
#figure 1
data_p<-panel_data(data,id=country,wave=year) #to use with line_plot()
data_p1<-subset(data_p,`country` %in% c("Algeria","Angola","Benin","Botswana",
                                        "Burundi","Burkina Faso","Cabo Verde",
                                        "Cameroon","Central African Republic",
                                        "Chad","Comoros","Cote d'Ivoire",
                                        "Democratic Republic of the Congo",
                                        "Djibouti","Egypt","Equatorial Guinea",
                                        "Eritrea","Eswatini","Ethiopia","Gabon",
                                        "Gambia","Ghana","Guinea","Guinea-Bissau",
                                        "Kenya","Lesotho"))
plot1<-data_p1 %>% #using 1700 width, 1200 height for export
  line_plot(log_wbloan,
            overlay = FALSE) +
  geom_line(mapping=aes(y=log_cloan),data=data_p1)
data_p2<-subset(data_p,`country` %in% c("Liberia","Libya",
                                        "Madagascar","Malawi","Mali","Mauritania",
                                        "Somalia","Mauritius","Morocco",
                                        "Mozambique","Namibia","Niger","Nigeria",
                                        "Republic of the Congo","Rwanda","Senegal",
                                        "Sierra Leone","South Africa","Togo",
                                        "Tunisia","Uganda","Seychelles",
                                        "South Sudan","Sudan","Sao Tome and Principe",
                                        "Tanzania","Zambia","Zimbabwe"))
plot2<-data_p2 %>% #using 1700 width, 1200 height for export
  line_plot(log_wbloan,
            overlay = FALSE) +
  geom_line(mapping=aes(y=log_cloan),data=data_p2)
################################################################################
#figure 2
data2<-data %>%
  drop_na() %>%
  group_by(year) %>%
  summarise(conditions=sum(conditions)) %>% #sum of every country's avg conditions per project in a given year
  select(-year)
data_ts<-data2 %>%
  ts(.,start = 2004,end = 2017)
plot.ts(data_ts) #width 550 for these, height 500
data3<-data %>%
  group_by(year) %>%
  summarise(log_wbloan=sum(log_wbloan),log_cloan=sum(log_cloan)) %>% #sum of every country's avg conditions per project in a given year
  select(-year)
data_ts2<-data3 %>%
  select(-log_wbloan) %>%
  ts(.,start = 2004,end = 2017)
plot.ts(data_ts2)
data_ts3<-data3 %>%
  select(-log_cloan) %>%
  ts(.,start = 2004,end = 2017)
plot.ts(data_ts3)
```

<!-- Conducting empirical analysis. -->
```{r}
################################################################################
#panel data frame, panel unit root testing
pdata<-pdata.frame(data,index = c("country","year"))
purtest(pdata$conflicts,test = c("ips"))
################################################################################
borrowing<-plm(borrowing~conditions+lag_cvote+log_gdp+polity,pdata,model=c("within"))
summary(borrowing) #lower conditions should increase borrowing (due to taking Chinese loans to reduce conditions)
conflict<-plm(conflicts~conditions+log_gdp+polity,pdata,model=c("within"))
summary(conflict) #Lower conditionality should increase conflict (due to implied presence of Chinese debt)
effectiveness<-plm(emissions~log_cloan+log_gdp+polity,pdata,model=c("within"))
summary(effectiveness) #Chinese money should increase emissions (due to decreased effectiveness of WB conditions)
```